name: PR Status Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-checks:
    name: PR Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better diffs
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Check PR title
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        if [[ ! $PR_TITLE =~ ^(feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?: ]]; then
          echo "‚ùå PR title must follow conventional commits format"
          echo "Example: feat: add new feature"
          echo "Types: feat, fix, docs, style, refactor, test, chore, perf"
          exit 1
        fi
        echo "‚úÖ PR title follows conventional commits"
    
    - name: Check changed files
      id: changed-files
      run: |
        echo "Changed files:"
        git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }}
        
        # Count changed files
        CHANGED_COUNT=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | wc -l)
        echo "changed_count=$CHANGED_COUNT" >> $GITHUB_OUTPUT
        
        if [ $CHANGED_COUNT -gt 50 ]; then
          echo "‚ö†Ô∏è Warning: PR changes $CHANGED_COUNT files. Consider splitting into smaller PRs."
        fi
    
    - name: Check for package-lock changes without package.json
      run: |
        PACKAGE_LOCK_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -c "package-lock.json" || true)
        PACKAGE_JSON_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -c "package.json" || true)
        
        if [ $PACKAGE_LOCK_CHANGED -gt 0 ] && [ $PACKAGE_JSON_CHANGED -eq 0 ]; then
          echo "‚ö†Ô∏è Warning: package-lock.json changed without package.json changes"
          echo "This might indicate an inconsistent npm install"
        fi
    
    - name: Add PR comment with checks summary
      uses: actions/github-script@v8
      with:
        script: |
          const changedCount = ${{ steps.changed-files.outputs.changed_count }};
          
          let body = '## ü§ñ Automated PR Checks\n\n';
          body += '‚úÖ PR title follows conventional commits\n';
          body += `üìù Files changed: ${changedCount}\n\n`;
          
          if (changedCount > 30) {
            body += '‚ö†Ô∏è **Warning:** Large PR detected. Consider splitting for easier review.\n\n';
          }
          
          body += '---\n';
          body += '*This comment is automatically generated by GitHub Actions*';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
