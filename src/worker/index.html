<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <title>Worker</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body>
    Workeruje
    <script>
        if (window.Worker) {
            const myWorker = new Worker('worker.js');
            let socket;
            let latency;
            let benchmarkScore;

            function initializeMainConnection() {
                socket = io(`http://${window.location.hostname}:8080/worker`);

                socket.on("connect", () => {
                    const pingStart = performance.now();
                    socket.emit("ping_resultSocket");

                    socket.on("pong_resultSocket", () => {
                        latency = (performance.now() - pingStart).toFixed(2);
                        myWorker.postMessage({ type: 'run_benchmark' });
                    });
                });

                socket.on("task_batch", (batch) => {
                    myWorker.postMessage({ type: 'task_batch', data: batch });
                });

                socket.on("custom_wasm_available", (data) => {
                    myWorker.postMessage({ type: 'custom_wasm_available', data: data });
                });

                socket.on("unload_custom_wasm", (data) => {
                    myWorker.postMessage({ type: 'unload_custom_wasm', data: data });
                });

                socket.on("connect_error", (err) => {
                    console.error("[Main] Connection Error:", err.message);
                });

                socket.on("disconnect", (reason) => {
                    console.log(`[Main] Disconnected from server: ${reason}`);
                });
            }


            myWorker.onmessage = function (e) {
                const message = e.data;

                switch (message.type) {
                    case 'worker_script_ready':
                        initializeMainConnection();
                        break;
                    case 'benchmark_result':
                        benchmarkScore = message.score;
                        const workerInfo = {
                            system: {
                                platform: navigator.platform,
                                userAgent: navigator.userAgent,
                                language: navigator.language,
                                hardwareConcurrency: navigator.hardwareConcurrency,
                                deviceMemory: navigator.deviceMemory || 'unknown'
                            },
                            performance: {
                                benchmarkScore: parseFloat(parseFloat(benchmarkScore).toFixed(2)),
                                latency: parseFloat(latency)
                            }
                        };
                        socket.emit("register", workerInfo);
                        break;
                    case 'batch_progress':
                        const progressDataForServer = {
                            clientId: message.data.clientId,
                            result: message.data.partialResult,
                            tasksCount: message.data.tasksProcessedInChunk,
                            method: message.data.method,
                            a: message.data.a,
                            b: message.data.b,
                        };
                        socket.emit("batch_result", progressDataForServer);

                        break;
                    case 'task_error':
                        socket.emit("task_error", message.data);
                        break;
                    case 'worker_error':
                        if (message.data.clientId) {
                            socket.emit("worker_error", { clientId: message.data.clientId, error: message.data.error });
                        }
                        break;
                    case 'custom_module_loaded':
                        socket.emit("custom_module_loaded", message.data);
                        break;
                    default:
                        console.log('[Main] Received unhandled message type from worker:', message.type);
                }
            };

            myWorker.onerror = function (e) {
                console.error('[Main] Error from worker:', e.message, 'at', e.filename, ':', e.lineno);
            };

        } else {
            console.error('[Main] Web Workers are not supported in this browser.');
        }
    </script>
</body>

</html>