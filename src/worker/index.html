<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <title>worker</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body>
</body>
<script src="benchmark/benchmark.js"></script>
<script src="index.js"></script>
<script>
    const socket = io(`http://${window.location.hostname}:8080/worker`);
    const resultSocket = io(`http://${window.location.hostname}:8090/worker`);


    let score;
    BenchmarkModule().then(benchmark => {
        const t0 = performance.now();
        benchmark.ccall("benchmark");
        const t1 = performance.now();
        //kwestia dyskusyjna czy tutaj wplywa na wydajnosc zaokraglenie wyniku /==/ do rozstrzygniecia
        score = (1 / (t1 - t0).toFixed(2)).toFixed(4) * 1000;

        const browserInfo = `System: ${navigator.platform}, moc przeglÄ…darki: ${score}`;

        socket.on("connect", () => {
            socket.emit("register", { name: browserInfo, benchmarkScore: parseFloat(score) });
        });
    });
    Module.onRuntimeInitialized = () => {
        //let localTotal = 0;
        socket.on("task_batch", (batch) => {
            for (const data of batch) {
                //const t0 = performance.now();
                const result = Module.ccall("add", "number", ["number", "number", "number"], [data.a, data.b, data.dx]);
                //const t1 = performance.now();

                //const duration = (t1 - t0).toFixed(2);

                //do debugowania
                //document.getElementById("result").textContent = result.toFixed(6);
                //localTotal += result;
                //document.getElementById("final_result").textContent = localTotal.toFixed(6);

                resultSocket.emit("result", {
                    taskId: data.taskId,
                    clientId: data.clientId,
                    result: result,
                    //duration: parseFloat(duration)
                });
            }
        });
    };
</script>


</html>